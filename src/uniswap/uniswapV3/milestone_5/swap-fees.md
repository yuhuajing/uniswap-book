# ‰∫§ÊòìË¥πÁéá

Ê≠£Â¶ÇÁÆÄ‰ªã‰∏≠ÊâÄËØ¥Ôºå‰∫§ÊòìË¥πÁéáÊòØ `Uniswap` ÁöÑ‰∏Ä‰∏™Ê†∏ÂøÉÊú∫Âà∂„ÄÇ
- `LP` ÈúÄË¶Å‰ªéÊèê‰æõÊµÅÂä®ÊÄß‰∏≠Ëé∑ÂæóÊî∂Áõä
- ÊØè‰∏ÄÁ¨î `swap` ‰∏≠ÈÉΩ‰ºö‰ªòÂá∫‰∏ÄÂ∞èÁ¨îË¥πÁî®,Ëøô‰∫õË¥πÁî®Â∞Ü‰ºöÊåâÊèê‰æõÁöÑÊµÅÂä®ÊÄßÂç†ÊØîÂàÜÈÖçÁªôÂú®‰∫§Êòì‰ª∑Ê†º‰∏äÊèê‰æõÊµÅÂä®ÊÄßÁöÑ `LP`„ÄÇ

## ÊâãÁª≠Ë¥π

Âú® V2 ‰∏≠ÔºåÂõ†‰∏∫Â§ßÂÆ∂Êèê‰æõÁöÑÊµÅÂä®ÊÄßÈÉΩÊòØÁªü‰∏ÄÁöÑÊâãÁª≠Ë¥πÊ†áÂáÜÔºà`0.3%`ÔºâÔºåÁªü‰∏ÄÁöÑ‰ª∑Ê†ºÂå∫Èó¥(`0, ‚àû`):
- ÊâÄ‰ª•Â§ßÂÆ∂ÁöÑËµÑÈáëÈÉΩÊòØÂùáÂåÄÂàÜÂ∏ÉÂú®Êï¥‰∏™‰ª∑Ê†ºËΩ¥‰πã‰∏äÁöÑÔºå 
- Âõ†Ê≠§Âú®ÊØè‰∏ÄÁ¨î‰∫§ÊòìÁöÑËøáÁ®ã‰∏≠ÔºåÂ§ßÂÆ∂Êî∂ÂèñÊâãÁª≠Ë¥πÁöÑÊùÉÈáçËÆ°ÁÆóÊØî‰æã‰πüÂ∫îËØ•ÊòØÁõ∏Á≠âÁöÑ„ÄÇ 
- Âç≥ÊØè‰∏ÄÁ¨îÊâãÁª≠Ë¥πÁöÑÊî∂ÁõäÂàÜÈÖçÔºåÂè™Âü∫‰∫éÁî®Êà∑Êèê‰æõÁöÑÊµÅÂä®ÊÄßÁõ∏ÂØπ‰∫éÊÄªÊµÅÂä®ÊÄßÁöÑÊØî‰æãÊù•ÂàÜÈÖçÔºåÂá∫ËµÑÂ§öÁöÑÂæóÂà∞ÁöÑÊî∂ÁõäÂ§ö„ÄÇ

ÁÑ∂ËÄå V3 ÁöÑ‰ª∑Ê†ºÂå∫Èó¥ÂÅöÂ∏ÇÊú∫Âà∂ÔºåËÆ©ÊµÅÂä®ÊÄßÈÉΩÊúâ‰∏çÂêåÁöÑÂÅöÂ∏ÇÂå∫Èó¥Ôºö
- ‰πüÂ∞±ÊòØËØ¥‰∏çÂêåÁöÑ‰∫§Êòì‰ª∑Ê†ºÔºå‰ΩøÁî®ÁöÑÊµÅÂä®ÊÄßÊòØ‰∏çÂêåÁöÑ
- ÈÇ£‰πàËøô‰∏™Êó∂ÂÄôÔºåÂÜçÁî®Âá∫ËµÑÊØî‰æãÊù•ÂàÜÈÖçÔºåÊòØ‰∏çÂêàÈÄÇÁöÑ

Ê≠£Á°ÆÁöÑÊñπÂºèÂ∫îËØ•ÊòØËÆ∞ÂΩïÊØè‰∏ÄÁ¨î‰∫§ÊòìÔºåÈÉΩ‰ΩøÁî®‰∫ÜÂì™‰∫õÊµÅÂä®ÊÄßÂ§¥ÂØ∏ `position(tick_index)`ÔºåÂÜçÂ∞ÜËøô‰πà‰∫õÂ§¥ÂØ∏Ê±áÊÄªÔºåÊåâÊØî‰æãÂàÜÈÖç„ÄÇ

ËøôÊ†∑Âú®ÁêÜËÆ∫‰∏äÊù•ËØ¥ÊòØÂêàÁêÜÁöÑÔºåÂ¶ÇÊûúÊòØ‰∏≠ÂøÉÂåñÁöÑÁΩëÁªúËøô‰πàÂπ≤ÁöÑÊàêÊú¨ÂèØËÉΩÊâøÂèóÁöÑËµ∑Ôºå
‰ΩÜÊîæÂà∞Âå∫ÂùóÈìæÁöÑËøêË°åÁéØÂ¢É‰∏≠ÔºåÈ¢ëÁπÅÁöÑËøõË°åÈ´òÊòÇÁöÑËØªÂÜôÊìç‰ΩúÊòØ‰∏çÂèØË°åÁöÑÔºå‰ºö‰∏∫Áî®Êà∑Â∏¶Êù•ÊûÅÈ´òÁöÑ gas Ë¥πÁî®Ôºå
‰ΩøÂæó‰∫§ÊòìÁöÑÊë©Êì¶ÊàêÊú¨È£ôÂçáÔºåÂèòÂæó‰∏çÂàíÁÆó„ÄÇ

## Ë¥πÁéáÂ¶Ç‰ΩïÊî∂ÈõÜ
![Liquidity ranges and fees](../images/milestone_5/liquidity_ranges_fees.png)

‰∫§ÊòìË¥πÁî®‰ªÖ‰ªÖÂΩì‰∏Ä‰∏™‰ª∑Ê†ºÂå∫Èó¥Âú®‰ΩøÁî®‰∏≠ÁöÑÊó∂ÂÄôÊâç‰ºöË¢´Êî∂ÈõÜÂà∞Ëøô‰∏™Âå∫Èó¥‰∏≠„ÄÇ

1. ÂΩì‰ª∑Ê†º‰∏äÂçáÔºå`tick` Á©øËøá‰ª∑Ê†ºÂå∫Èó¥ÁöÑ‰∏ãÁïåÔºõË°®Á§∫Âõ†‰∏∫‰ª∑Ê†º‰∏äÊ∂®ÔºåÂêëÂè≥ËøõÂÖ•Êñ∞ÁöÑ `tick` Âå∫Èó¥Ôºõ
2. ÂΩì‰ª∑Ê†º‰∏ãÈôçÔºå`tick` Á©øËøá‰ª∑Ê†ºÂå∫Èó¥ÁöÑ‰∏äÁïåÔºõË°®Á§∫Âõ†‰∏∫‰ª∑‰∏ãË∑åÔºåÂêëÂ∑¶ËøõÂÖ•Êñ∞ÁöÑ `tick` Âå∫Èó¥Ôºõ

ËÄåÂú®‰∏ãÂàóÁöÑÊó∂Âàª‰∏Ä‰∏™‰ª∑Ê†ºÂå∫Èó¥Ë¢´ÂÅúÁî®Ôºö
1. ÂΩì‰ª∑Ê†º‰∏äÂçáÔºå`tick` Á©øËøá‰ª∑Ê†ºÂå∫Èó¥ÁöÑ‰∏äÁïå,Ë°®Á§∫Âõ†‰∏∫‰ª∑Ê†º‰∏äÊ∂®Á¶ªÂºÄÂΩìÂâç `tick` Âå∫Èó¥Ôºõ
2. ÂΩì‰ª∑Ê†º‰∏ãÈôçÔºå`tick` Á©øËøá‰ª∑Ê†ºÂå∫Èó¥ÁöÑ‰∏ãÁïåÔºõ

![Liquidity range engaged/disengaged](../images/milestone_5/liquidity_range_engaged.png)

Èô§‰∫ÜÁü•ÈÅì‰ΩïÊó∂‰∏Ä‰∏™Âå∫Èó¥‰ºöË¢´ÊøÄÊ¥ª/ÂÅúÁî®‰ª•Â§ñÔºåËøòÂ∏åÊúõËÉΩÂ§üË∑üË∏™ÊØè‰∏™‰ª∑Ê†ºÂå∫Èó¥Á¥ØÁßØ‰∫ÜÂ§öÂ∞ëË¥πÁî®„ÄÇ

‰∏∫‰∫ÜËÆ©Ë¥πÁî®ËÆ°ÁÆóÊõ¥ÁÆÄÂçïÔºå`Uniswap V3` Ë∑üË∏™**swap‰∫§Êòì‰∫ßÁîüÁöÑÊÄªÊâãÁª≠Ë¥π**„ÄÇ

‰πãÂêéÔºå‰ª∑Ê†ºÂå∫Èó¥ÁöÑË¥πÁî®ÈÄöËøáÊÄªË¥πÁî®ËÆ°ÁÆóÂá∫Êù•Ôºö **_ÊÄªÊâãÁª≠Ë¥πÂáèÂéª‰ª∑Ê†ºÂå∫Èó¥‰πãÂ§ñÁ¥ØËÆ°ÁöÑË¥πÁî®_**„ÄÇ

## ËÆ°ÁÆó Position(a,b) Á¥ØÁßØË¥πÁî®
‰∏∫‰∫ÜËÆ°ÁÆó‰∏Ä‰∏™ `position` Á¥ØËÆ°ÁöÑÊÄªË¥πÁî®ÔºåÊàë‰ª¨ÈúÄË¶ÅËÄÉËôë‰∏§ÁßçÊÉÖÂÜµÔºö

### ÂΩìÁé∞‰ª∑Âú®Ëøô‰∏™Âå∫Èó¥ÂÜÖ:

ÂáèÂéªÂà∞ÁõÆÂâç‰∏∫Ê≠¢ÔºåËøô‰∫õ `tick` ‰πãÂ§ñÁ¥ØÁßØÁöÑË¥πÁî®Ôºö

![Fees accrued inside and outside of a price range](../images/milestone_5/fees_inside_and_outside_price_range.png)

```math
feeGrowthInside = feeGrowthGlobal - feeGrowthOutside_below - feeGrowthOutside_above
```

`feeGrowthOutside_below` ÂØπÂ∫î `(0, a)` Âå∫Èó¥Ôºå `feeGrowthOutside_above` ÂØπÂ∫î `(b, ‚àû)` Âå∫Èó¥„ÄÇ

### ÂΩìÁé∞‰ª∑‰∏çÂú®Ëøô‰∏™Âå∫Èó¥ÂÜÖ:
ÂÅáËÆæÊàë‰ª¨ÈúÄË¶ÅËÆ°ÁÆó a, b ‰∏§ÁÇπÂå∫Èó¥ÂÜÖÁöÑÊâãÁª≠Ë¥πÔºåÊ≠§Êó∂ `i_current` ÂΩìÂâçÂú® b ÁÇπÂè≥‰æß„ÄÇ

| . | . | . | . | . | . | . | . |
| - | - | - | - | - | - | - | - |
| ... |  | a |  | b |  | i | ... |


`i_current` ÂΩìÂâçÂú® b ÁÇπÂè≥‰æßÔºåÊ≠§Êó∂ `feeGrowthOutside_b` ÂÆûÈôÖ‰∏äËÆ∞ÂΩïÁöÑÊòØ b ÁÇπÂ∑¶‰æßÁöÑÊâãÁª≠Ë¥πÔºåËÄåÊàë‰ª¨ÈúÄË¶ÅËÆ°ÁÆóÁöÑ above Â∫îËØ•ÊòØ b ÁÇπÂè≥‰æßÁöÑÊâãÁª≠Ë¥πÔºåÊâÄ‰ª•ËøôÈáåÂÖ∂ÂÆûÊòØÈúÄË¶ÅÁî® `feeGrowthGlobal` ÂáèÂéª `feeGrowthOutside_b`.

```math
feeGrowthOutside_below = feeGrowthOutside_a // aÁÇπÊâÄÂØπÂ∫îÁöÑtickÁöÑfeeGrowthOutside
feeGrowthOutside_above = feeGrowthGlobal - feeGrowthOutside_b // bÁÇπÊâÄÂØπÂ∫îÁöÑtickÁöÑfeeGrowthOutside
```

‰ª£ÂÖ•‰πãÂâçÁöÑÂÖ¨Âºè

```math
feeGrowthInside = feeGrowthGlobal - feeGrowthOutside_a - (feeGrowthGlobal - feeGrowthOutside_b)
```

**Ê≥®ÊÑèÊ†πÊçÆ `i_current`, `a`, `b` ‰∏âËÄÖ‰ΩçÁΩÆÂÖ≥Á≥ª‰∏çÂêåÔºåÈúÄË¶ÅÂà§Êñ≠ above Âíå below ÁöÑËÆ°ÁÆóÊñπÂºè**ÔºåÂÖ∑‰ΩìÈÄªËæëÂú® `Tick.sol` ÁöÑ `getFeeGrowInside()` ‰∏≠„ÄÇ

## ÊúâÊµÅÂä®ÊÄßÊ≥®ÂÖ•
Âú®‰ª∑Ê†ºÁöÑËæπÁïåÂØπÂ∫îÁöÑ `tick` ‰∏äÊúâÂ¶Ç‰∏ãÂàùÂßãÂåñËßÑÂàôÔºö

üéØ ËßÑÂàôËØ¥Êòé

- ÂΩì `tick` > ÂΩìÂâç‰ª∑Ê†ºÔºà`i > i_current`ÔºâÊó∂ÔºåÊàë‰ª¨ËÆ§‰∏∫ËØ• `tick` ÊòØ‚ÄúÂú®‰∏äÊñπ‚Äù„ÄÇ
  - `feeGrowthOutside = feeGrowthGlobal`
- ÂΩì `tick` <= ÂΩìÂâç‰ª∑Ê†ºÔºà`i <= i_current`ÔºâÊó∂ÔºåÊàë‰ª¨ËÆ§‰∏∫ËØ• `tick` ÊòØ‚ÄúÂú®‰∏ãÊñπ‚Äù„ÄÇ
  - `feeGrowthOutside = 0`

### üß™ Á§∫‰æã 1Ôºö
Ê∑ªÂä†ÊµÅÂä®ÊÄßÂå∫Èó¥: `(tickLower=100, tickUpper=200)`

ÂΩìÂâç` tickÔºài_currentÔºâ= 150`

`feeGrowthGlobal = 1000`

ÂàùÂßãÂåñ‰∏§‰∏™ tick:

| Tick | Áõ∏ÂØπ‰ΩçÁΩÆ   | ËÆæÁΩÆ feeGrowthOutside    |
| ---- | ------ | ---------------------- |
| 100  | ‚â§ ÂΩìÂâç‰ª∑Ê†º | 0                      |
| 200  | > ÂΩìÂâç‰ª∑Ê†º | feeGrowthGlobal = 1000 |

```solidity
tick[100].feeGrowthOutside = 0;
tick[200].feeGrowthOutside = 1000;
```

## Cross-tick‰∫§Êòì
`feeGrowthOutside` ÊúâÂ¶Ç‰∏ãÊõ¥Êñ∞ËßÑÂàôÔºö

- ÂΩì‰ª∑Ê†ºÁ©øËøáÊüê‰∏™Â∑≤ÂàùÂßãÂåñÁöÑ `tick` Êó∂ÔºåËØ• `tick` ‰∏äÁöÑ `feeGrowthOutside` ÈúÄË¶ÅÁøªËΩ¨ÔºåÂõ†‰∏∫Â§ñ‰æßÊâãÁª≠Ë¥πÊ∞∏ËøúË¶ÅÂú®ÂΩìÂâç‰ª∑Ê†ºÁöÑÂè¶‰∏Ä‰æß
- `feeGrowthOutside = feeGrowthGlobal - feeGrowthOutside`
### Á§∫‰æã 
‚úÖ Âü∫Á°ÄËÆæÂÆö

- ÂàùÂßãÂÖ®Â±ÄÊâãÁª≠Ë¥πÔºö`feeGrowthGlobal = 100 `
- Ëµ∑Âßã `tick`Ôºö`tick = 150 `
- ‰∏§ÊÆµÊµÅÂä®ÊÄßÂå∫Èó¥ÔºàÂç≥ `LP` Ê∑ªÂä†ÁöÑÊµÅÂä®ÊÄßÔºâÔºö 
  - Âå∫Èó¥ `A-B`Ôºö `[100, 200)Ôºåtick a=100Ôºåtick b=200 `
  - Âå∫Èó¥ `C-D`Ôºö `[300, 400)Ôºåtick c=300Ôºåtick d=400`

ÊâãÁª≠Ë¥πÂèòÂåñËøáÁ®ãÔºö

- ‰ª∑Ê†º‰ªé `tick 150` ÂºÄÂßã 
- Ë∑®Ëøá `tick 200` ‚Üí ËøõÂÖ• `tick` Âå∫Èó¥ `C-D` ÂâçÔºåËøò‰ºöÊúâ‰∏Ä‰∏™‰ªé `feeGrowthGlobal = 180` Âà∞ `300` 
- ÁªßÁª≠‰∏äÂçáÂêéËøõÂÖ•Âå∫Èó¥ `C-D`Ôºå`feeGrowthGlobal = 500`

### Èò∂ÊÆµ 0ÔºöÂàùÂßãÂåñÊó∂ tick = 150ÔºåfeeGrowthGlobal = 100
- tick a = 100ÔºàÂ∑¶ËæπÔºâ‚áí feeGrowthOutside = 0 
- tick b = 200ÔºàÂè≥ËæπÔºâ‚áí feeGrowthOutside = 100 
- tick c = 300ÔºàÂè≥ËæπÔºâ‚áí feeGrowthOutside = 100 
- tick d = 400ÔºàÂè≥ËæπÔºâ‚áí feeGrowthOutside = 100

#### 1 swapÂú®(a,b)
Âú® `Ôºàa,bÔºâ`ÊâßË°å `swap`, `glb = 100 +80 = 180`

ÊâãÁª≠Ë¥πËÆ°ÁÆóÔºö
```math
feeGrowthInside(a,b) = feeGrowthGlobal - feeGrowthOutside_a - feeGrowthOutside_b = 180 - 0 -100 = 80
```

#### 2 ‰ª∑Ê†º‰∏äÊ∂®ÂêéË∑®Âà∞ Ôºàc,dÔºâÂå∫Èó¥
Âú® `Ôºàa,bÔºâ-> (c,d)`ÊâßË°å `swap`, `glb = 180->300->500`

Cross b: `tick[b].feeGrowthOutside = feeGrowthGlobal - feeGrowthOutside= 300-100 = 200`

cross c: `tick[c].feeGrowthOutside = feeGrowthGlobal - feeGrowthOutside= 300-100 = 200`

ÊâãÁª≠Ë¥πËÆ°ÁÆóÔºö
```math
feeGrowthInside(a,b) = |feeGrowthOutside_a - feeGrowthOutside_b| = |0 - 200| = 200

feeGrowthInside(c,d) = feeGrowthGlobal - feeGrowthOutside_c - feeGrowthOutside_d = 500 - 200 - 100 = 200
```

üßÆ ÊÄªÁªìÔºö‰∏âÁßçÂú∫ÊôØÊ±áÊÄªË°®

| Âú∫ÊôØ           | Tick Áõ∏ÂØπÂΩìÂâç‰ª∑Ê†º  | feeGrowthOutside ÂàùÂßãÂåñÂÄº          | Ë∑®Ë∂äÂêéÂ¶Ç‰ΩïÂèòÂåñ |
| ------------ | ------------ | ------------------------------ | ------- |
| ÊµÅÂä®ÊÄßÊ≥®ÂÖ•Ôºötick ‰Ωé | ‚â§ i\_current | 0                              | Êó†       |
| ÊµÅÂä®ÊÄßÊ≥®ÂÖ•Ôºötick È´ò | > i\_current | feeGrowthGlobal                | Êó†       |
| Tick ÂêëÂè≥Á©øË∂ä    | ‰ªé ‚â§ i Âà∞ > i  | `feeGrowthOutside = fgG - old` | ‚ÄúÂ§ñÈÉ®‚ÄùÊç¢Ëæπ  |
| Tick ÂêëÂ∑¶Á©øË∂ä    | ‰ªé > i Âà∞ ‚â§ i  | `feeGrowthOutside = fgG - old` | ‚ÄúÂ§ñÈÉ®‚ÄùÊç¢Ëæπ  |


## ËßÑÂàôÂõûÈ°æ
1. Áî®Êà∑ `swap token` ÁöÑÊó∂ÂÄôÊîØ‰ªòË¥πÁî®„ÄÇËæìÂÖ• `token` ‰∏≠ÁöÑ‰∏ÄÂ∞èÈÉ®ÂàÜÂ∞Ü‰ºöË¢´ÂáèÂéªÔºåÂπ∂Á¥ØÁßØÂà∞Ê±†Â≠êÁöÑ‰ΩôÈ¢ù‰∏≠„ÄÇ
2. ÊØè‰∏™Ê±†Â≠êÈÉΩÊúâ `feeGrowthGlobal0X128` Âíå `feeGrowthGlobal1X128` ‰∏§‰∏™Áä∂ÊÄÅÂèòÈáèÔºåÊù•Ë∑üË∏™ÊØèÂçï‰ΩçÁöÑÊµÅÂä®ÊÄßÁ¥ØËÆ°ÁöÑÊÄªË¥πÁî®Ôºà‰πüÂç≥ÔºåÊÄªÁöÑË¥πÁî®Èô§‰ª•Ê±†Â≠êÊµÅÂä®ÊÄßÔºâ„ÄÇ
3. `tick` Ë∑üË∏™Âú®ÂÆÉ‰πãÂ§ñÁ¥ØÁßØÁöÑË¥πÁî®
- ÂΩìÊ∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑ‰ΩçÁΩÆÂπ∂ÊøÄÊ¥ª‰∏Ä‰∏™ tick ÁöÑÊó∂ÂÄô
  - tick ‰ΩçÁΩÆ‰ª∑Ê†ºÈ´ò‰∫éÁé∞‰ª∑ slot0.tick, `feeGrowthOutside = fee_global`
  - tick ‰ΩçÁΩÆ‰ª∑Ê†ºÈ´òÂ∞è‰∫éÁ≠â‰∫éÁé∞‰ª∑ slot0.tick, `feeGrowthOutside = 0`
4. ÊØèÂΩì‰∏Ä‰∏™ `tick` Ë¢´ `cross` Êó∂,Âú®Ëøô‰∏™ `tick` ‰πãÂ§ñÁßØÁ¥ØÁöÑË¥πÁî®Â∞±‰ºöÊõ¥Êñ∞‰∏∫:
- `feeGrowthOutside = feeGrowthGlobal - feeGrowthOutside`
5. `tick` Áü•ÈÅì‰∫ÜÂú®‰ªñ‰πãÂ§ñÁ¥ØÁßØ‰∫ÜÂ§öÂ∞ëË¥πÁî®ÔºåÂ∞±ÂèØ‰ª•ËÆ©Êàë‰ª¨ËÆ°ÁÆóÂá∫Âú®‰∏Ä‰∏™ `position` ÂÜÖÈÉ®Á¥ØÁßØ‰∫ÜÂ§öÂ∞ëË¥πÁî®Ôºà`position` Â∞±ÊòØ‰∏§‰∏™ `tick` ‰πãÈó¥ÁöÑÂå∫Èó¥Ôºâ„ÄÇ
6. Áü•ÈÅì‰∫Ü‰∏Ä‰∏™ `position` ÂÜÖÈÉ®Á¥ØÁßØ‰∫ÜÂ§öÂ∞ëË¥πÁî®ÔºåÂ∞±ËÉΩÂ§üËÆ°ÁÆó `LP` ËÉΩÂ§üÂàÜÊàêÂà∞Â§öÂ∞ëË¥πÁî®„ÄÇ
- Â¶ÇÊûú‰∏Ä‰∏™ `position` Ê≤°ÊúâÂèÇ‰∏éÂà∞‰∫§Êòì‰∏≠ÔºåÂÆÉÁöÑÁ¥ØËÆ°Ë¥πÁéá‰ºöÊòØ 0
- Âú®Ëøô‰∏™Âå∫Èó¥Êèê‰æõÊµÅÂä®ÊÄßÁöÑ LP Â∞Ü‰∏ç‰ºöËé∑Âæó‰ªª‰ΩïÂà©Ê∂¶„ÄÇ

## Á¥ØÁßØ‰∫§ÊòìË¥πÁî®
### Ê¶ÇÂøµËØ¥Êòé
üß± ËÉåÊôØÊ¶ÇÂøµÁÆÄËø∞

`tick`Ôºö`UniswapV3` Â∞Ü‰ª∑Ê†ºÁ©∫Èó¥Á¶ªÊï£Âåñ‰∏∫‰∏ÄÁ≥ªÂàóÊï¥Êï∞ `tick`Ôºå‰ª∑Ê†ºÂèòÂä®Â∞±ÊòØ `tick` ÁöÑÁßªÂä®„ÄÇ

`feeGrowthGlobal`ÔºöË°®Á§∫ÂΩìÂâçÊ±†Â≠êÊï¥‰ΩìÁ¥ØËÆ°ÁöÑÊâãÁª≠Ë¥πÂ¢ûÈïø„ÄÇ

`feeGrowthOutside`ÔºöËÆ∞ÂΩïÊüê‰∏™ `tick` Â§ñÈÉ®Ôºà‰ª∑Ê†ºÂè¶‰∏Ä‰æßÔºâÁöÑÊâãÁª≠Ë¥πÁ¥ØËÆ°ÂÄºÔºåÁî®‰∫éÁ≤æÂáÜÂàÜÈÖç `LP` Êî∂Áõä„ÄÇ

`i_current`ÔºöÂΩìÂâç‰ª∑Ê†ºÂØπÂ∫îÁöÑ `tick`„ÄÇ

`tick` ËæπÁïåÊµÅÂä®ÊÄßÊ≥®ÂÖ•ÔºöÂç≥‰∏∫ÊµÅÂä®ÊÄßÂå∫Èó¥ËÆæÁΩÆ‰∏ä‰∏ãËæπÁïåÔºà`tick_lower`, `tick_upper`Ôºâ„ÄÇ

### Ê∑ªÂä†ÈúÄË¶ÅÁöÑÁä∂ÊÄÅÂèòÈáè
ÈúÄË¶ÅÂÅöÁöÑÁ¨¨‰∏Ä‰ª∂‰∫ãÊòØÂú®Ê±†Â≠ê‰∏≠Ê∑ªÂä†Ë¥πÁéáÂèÇÊï∞‚Äî‚ÄîÊØè‰∏™Ê±†Â≠êÈÉΩÊúâ‰∏Ä‰∏™Âõ∫ÂÆö‰∏î‰∏çÂèØÂèòÁöÑË¥πÁéáÔºåÂú®ÈÉ®ÁΩ≤Êó∂ÈÖçÁΩÆ„ÄÇ

Ë¥πÁéáÂíå `tick` Èó¥ÈöîÁªëÂÆöÔºöË¥πÁéáË∂äÈ´òÔºå`tick` Èó¥ÈöîË∂äÂ§ß„ÄÇ

ËøôÊòØÂõ†‰∏∫Á®≥ÂÆöÊÄßË∂äÈ´òÁöÑÊ±†Â≠êÔºàÁ®≥ÂÆöÂ∏ÅÊ±†ÔºâÁöÑË¥πÁéáÂ∫îËØ•Êõ¥‰Ωé„ÄÇ

ËÆ©Êàë‰ª¨Êõ¥Êñ∞Â∑•ÂéÇÂêàÁ∫¶Ôºö
```solidity
// src/UniswapV3Factory.sol
contract UniswapV3Factory is IUniswapV3PoolDeployer {
    ...
    mapping(uint24 => uint24) public fees; // `tickSpacings` replaced by `fees`

    constructor() {
        fees[500] = 10;
        fees[3000] = 60;
    }

    function createPool(
        address tokenX,
        address tokenY,
        uint24 fee
    ) public returns (address pool) {
        ...
        parameters = PoolParameters({
            factory: address(this),
            token0: tokenX,
            token1: tokenY,
            tickSpacing: fees[fee],
            fee: fee
        });
        ...
    }
}
```

Ë¥πÁéáÁöÑÂçï‰ΩçÊòØÂü∫ÁÇπÁöÑÁôæÂàÜ‰πã‰∏ÄÔºå‰πüÂç≥‰∏Ä‰∏™Ë¥πÁéáÂçï‰ΩçÊòØ `0.0001%`Ôºå`500` ÊòØ `0.05%`Ôºå`3000` ÊòØ `0.3%`„ÄÇ

‰∏ã‰∏ÄÊ≠•ÊòØÂú®Ê±†Â≠ê‰∏≠Á¥ØÁßØ‰∫§ÊòìË¥πÁî®„ÄÇ‰∏∫‰ª¨Ë¶ÅÊ∑ªÂä†‰∏§‰∏™ÂÖ®Â±ÄË¥πÁî®Á¥ØÁßØÁöÑÂèòÈáèÔºö

```solidity
// src/UniswapV3Pool.sol
contract UniswapV3Pool is IUniswapV3Pool {
    ...
    uint24 public immutable fee;
    uint256 public feeGrowthGlobal0X128;
    uint256 public feeGrowthGlobal1X128;
}
```

### Âú® tick ‰∏≠Êõ¥Êñ∞Ë¥πÁî®ËøΩË∏™Âô®

Êé•‰∏ãÊù•ÔºåÈúÄË¶ÅÂú® `tick` ‰∏≠Êõ¥Êñ∞Ë¥πÁî®ËøΩË∏™Âô®ÔºàÂΩì‰∫§Êòì‰∏≠Á©øËøá‰∏Ä‰∏™ tick Êó∂ÔºâÔºö

```solidity
if (state.sqrtPriceX96 == step.sqrtPriceNextX96) {
    int128 liquidityDelta = ticks.cross(
        step.nextTick,
        (
            zeroForOne
                ? state.feeGrowthGlobalX128
                : feeGrowthGlobal0X128
        ),
        (
            zeroForOne
                ? feeGrowthGlobal1X128
                : state.feeGrowthGlobalX128
        )
    );
    ...
}
```

Áî±‰∫éÊ≠§Êó∂ËøòÊ≤°ÊúâÊõ¥Êñ∞ `feeGrowthGlobal0X128/feeGrowthGlobal1X128` Áä∂ÊÄÅÂèòÈáèÔºåÂèØ‰ª•Êää `state.feeGrowthGlobalX128` ‰Ωú‰∏∫ÂÖ∂‰∏≠‰∏Ä‰∏™ÂèÇÊï∞‰º†ÂÖ•„ÄÇ`cross` ÂáΩÊï∞Êõ¥Êñ∞Ë¥πÁî®ËøΩË∏™Âô®Ôºö

```solidity
// src/lib/Tick.sol
function cross(
    mapping(int24 => Tick.Info) storage self,
    int24 tick,
    uint256 feeGrowthGlobal0X128,
    uint256 feeGrowthGlobal1X128
) internal returns (int128 liquidityDelta) {
    Tick.Info storage info = self[tick];
    info.feeGrowthOutside0X128 =
        feeGrowthGlobal0X128 -
        info.feeGrowthOutside0X128;
    info.feeGrowthOutside1X128 =
        feeGrowthGlobal1X128 -
        info.feeGrowthOutside1X128;
    liquidityDelta = info.liquidityNet;
}
```

### Êõ¥Êñ∞ÂÖ®Â±ÄË¥πÁî®ËøΩË∏™Âô®

ÊúÄÂêé‰∏ÄÊ≠•ÔºåÂΩì‰∫§ÊòìÂÆåÊàêÊó∂ÔºåÈúÄË¶ÅÊõ¥Êñ∞ÂÖ®Â±ÄÁöÑË¥πÁî®ËøΩË∏™Ôºö

```solidity
if (zeroForOne) {
    feeGrowthGlobal0X128 = state.feeGrowthGlobalX128;
} else {
    feeGrowthGlobal1X128 = state.feeGrowthGlobalX128;
}
```

ÂêåÊ†∑Âú∞ÔºåÂú®‰∏ÄÁ¨î‰∫§Êòì‰∏≠Âè™Êúâ‰∏Ä‰∏™ÂèòÈáè‰ºöÊõ¥Êñ∞ÔºåÂõ†‰∏∫‰∫§ÊòìË¥π‰ªÖ‰ªéËæìÂÖ• `token` ‰∏≠Êî∂Âèñ„ÄÇ

### Êõ¥Êñ∞ position Ë¥πÁî®Âíå token Êï∞Èáè

‰∏ã‰∏ÄÊ≠•ÊòØËÆ°ÁÆó `position` Á¥ØËÆ°ÁöÑË¥πÁî®Âíå `token` Êï∞Èáè„ÄÇ

Áî±‰∫é‰∏Ä‰∏™ `position` Â∞±ÊòØ‰∏§‰∏™ `tick` ‰πãÈó¥ÁöÑ‰∏Ä‰∏™Âå∫Èó¥ÔºåÂèØ‰ª•‰ΩøÁî® `tick` ‰∏≠ÁöÑË¥πÁî®ËøΩË∏™Âô®Êù•ËÆ°ÁÆóËøô‰∫õÂÄº„ÄÇ

```solidity
// src/lib/Tick.sol
function getFeeGrowthInside(
    mapping(int24 => Tick.Info) storage self,
    int24 lowerTick_,
    int24 upperTick_,
    int24 currentTick,
    uint256 feeGrowthGlobal0X128,
    uint256 feeGrowthGlobal1X128
)
    internal
    view
    returns (uint256 feeGrowthInside0X128, uint256 feeGrowthInside1X128)
{
    Tick.Info storage lowerTick = self[lowerTick_];
    Tick.Info storage upperTick = self[upperTick_];

    uint256 feeGrowthBelow0X128;
    uint256 feeGrowthBelow1X128;
    if (currentTick >= lowerTick_) {
        feeGrowthBelow0X128 = lowerTick.feeGrowthOutside0X128;
        feeGrowthBelow1X128 = lowerTick.feeGrowthOutside1X128;
    } else {
        feeGrowthBelow0X128 =
            feeGrowthGlobal0X128 -
            lowerTick.feeGrowthOutside0X128;
        feeGrowthBelow1X128 =
            feeGrowthGlobal0X128 -
            lowerTick.feeGrowthOutside1X128;
    }

    uint256 feeGrowthAbove0X128;
    uint256 feeGrowthAbove1X128;
    if (currentTick < upperTick_) {
        feeGrowthAbove0X128 = upperTick.feeGrowthOutside0X128;
        feeGrowthAbove1X128 = upperTick.feeGrowthOutside1X128;
    } else {
        feeGrowthAbove0X128 =
            feeGrowthGlobal0X128 -
            upperTick.feeGrowthOutside0X128;
        feeGrowthAbove1X128 =
            feeGrowthGlobal0X128 -
            upperTick.feeGrowthOutside1X128;
    }

    feeGrowthInside0X128 =
        feeGrowthGlobal0X128 -
        feeGrowthBelow0X128 -
        feeGrowthAbove0X128;
    feeGrowthInside1X128 =
        feeGrowthGlobal1X128 -
        feeGrowthBelow1X128 -
        feeGrowthAbove1X128;
}
```
ÂæóÂà∞ `position` ÂÜÖÁ¥ØÁßØÁöÑË¥πÁî®ÂêéÔºåÂ∞±ÂèØ‰ª•Êõ¥Êñ∞ `position` ÂÜÖÁöÑË¥πÁî®ÂíåÊï∞ÈáèËøΩË∏™Âô®‰∫ÜÔºö

```solidity
// src/lib/Position.sol
function update(
    Info storage self,
    int128 liquidityDelta,
    uint256 feeGrowthInside0X128,
    uint256 feeGrowthInside1X128
) internal {
    uint128 tokensOwed0 = uint128(
        PRBMath.mulDiv(
            feeGrowthInside0X128 - self.feeGrowthInside0LastX128,
            self.liquidity,
            FixedPoint128.Q128
        )
    );
    uint128 tokensOwed1 = uint128(
        PRBMath.mulDiv(
            feeGrowthInside1X128 - self.feeGrowthInside1LastX128,
            self.liquidity,
            FixedPoint128.Q128
        )
    );

    self.liquidity = LiquidityMath.addLiquidity(
        self.liquidity,
        liquidityDelta
    );
    self.feeGrowthInside0LastX128 = feeGrowthInside0X128;
    self.feeGrowthInside1LastX128 = feeGrowthInside1X128;

    if (tokensOwed0 > 0 || tokensOwed1 > 0) {
        self.tokensOwed0 += tokensOwed0;
        self.tokensOwed1 += tokensOwed1;
    }
}
```

## ÁßªÈô§ÊµÅÂä®ÊÄß
ÁßªÈô§ÊµÅÂä®ÊÄß„ÄÇ‰∏é `mint` Áõ∏ÂØπÂ∫îÔºåÊàë‰ª¨ÊääËøô‰∏™ÂáΩÊï∞Âè´ÂÅö `burn`„ÄÇ

Ëøô‰∏™ÂáΩÊï∞ÂÖÅËÆ∏ `LP` ÁßªÈô§‰∏Ä‰∏™ `position` ‰∏≠ÈÉ®ÂàÜÊàñËÄÖÂÖ®ÈÉ®ÁöÑÊµÅÂä®ÊÄß„ÄÇ

Èô§Ê≠§‰πãÂ§ñÔºåÂÆÉ‰πü‰ºöËÆ°ÁÆó `LP` Â∫îËØ•ÂæóÂà∞ÁöÑÂà©Ê∂¶Êî∂ÂÖ•„ÄÇ

ÁÑ∂ËÄåÔºåÂÆûÈôÖÁöÑ `token` ËΩ¨Áßª‰ºöÂú®Âè¶‰∏Ä‰∏™ÂáΩÊï∞‰∏≠ÂÆûÁé∞‚Äî‚Äî`collect`„ÄÇ

### ÁáÉÁÉßÊµÅÂä®ÊÄß

ÁáÉÁÉßÊµÅÂä®ÊÄß‰∏éÈì∏ÈÄ†Áõ∏Âèç„ÄÇ
> ‰∏∫‰∫ÜÂÆûÁé∞ `burn`ÔºåÈúÄË¶ÅÈáçÊûÑ‰ª£Á†ÅÔºåÊää position ÁÆ°ÁêÜÁõ∏ÂÖ≥ÁöÑ‰ª£Á†ÅÔºàÊõ¥Êñ∞ tick Âíå positionÔºå‰ª•Âèä token Êï∞ÈáèÁöÑËÆ°ÁÆóÔºâÁßªÂä®Âà∞ `_modifyPosition` ÂáΩÊï∞‰∏≠ÔºåËøô‰∏™ÂáΩÊï∞‰ºöË¢´ `mint` Âíå `burn` ‰ΩøÁî®„ÄÇ


```solidity
function burn(
    int24 lowerTick,
    int24 upperTick,
    uint128 amount
) public returns (uint256 amount0, uint256 amount1) {
    (
        Position.Info storage position,
        int256 amount0Int,
        int256 amount1Int
    ) = _modifyPosition(
            ModifyPositionParams({
                owner: msg.sender,
                lowerTick: lowerTick,
                upperTick: upperTick,
                liquidityDelta: -(int128(amount))
            })
        );

    amount0 = uint256(-amount0Int);
    amount1 = uint256(-amount1Int);

    if (amount0 > 0 || amount1 > 0) {
        (position.tokensOwed0, position.tokensOwed1) = (
            position.tokensOwed0 + uint128(amount0),
            position.tokensOwed1 + uint128(amount1)
        );
    }

    emit Burn(msg.sender, lowerTick, upperTick, amount, amount0, amount1);
}
```

Âú® `burn` ÂáΩÊï∞‰∏≠ÔºåÈ¶ñÂÖàÊõ¥Êñ∞ `position`ÔºåÂπ∂‰ªé‰∏≠ÁßªÈô§‰∏ÄÂÆöÊï∞ÈáèÁöÑÊµÅÂä®ÊÄß„ÄÇ

Êé•‰∏ãÊù•ÔºåÊõ¥Êñ∞Ëøô‰∏™ `position` Â∫îÂæóÁöÑ `token` Êï∞Èáè
- ÂÆÉÂåÖÂê´Êèê‰æõÊµÅÂä®ÊÄßÊó∂ËΩ¨ÂÖ•ÁöÑ `token` Êï∞Èáè‰ª•ÂèäË¥πÁî®Êî∂ÂÖ•„ÄÇ
- ‰πüÂèØ‰ª•ÊääÂÆÉÁúãÂÅöÊää `position` ÊµÅÂä®ÊÄßËΩ¨Êç¢Âà∞ `token` ÁöÑËøáÁ®ã
- Ëøô‰∫õ `token` Â∞Ü‰∏ç‰ºöÂÜçË¢´Áî®‰∫éÊµÅÂä®ÊÄßÔºåÂπ∂‰∏îÂèØ‰ª•ÈÄöËøáË∞ÉÁî® `collect` ÂáΩÊï∞Êù•ËµéÂõûÔºö

```solidity
function collect(
    address recipient,
    int24 lowerTick,
    int24 upperTick,
    uint128 amount0Requested,
    uint128 amount1Requested
) public returns (uint128 amount0, uint128 amount1) {
    Position.Info memory position = positions.get(
        msg.sender,
        lowerTick,
        upperTick
    );

    amount0 = amount0Requested > position.tokensOwed0
        ? position.tokensOwed0
        : amount0Requested;
    amount1 = amount1Requested > position.tokensOwed1
        ? position.tokensOwed1
        : amount1Requested;

    if (amount0 > 0) {
        position.tokensOwed0 -= amount0;
        IERC20(token0).transfer(recipient, amount0);
    }

    if (amount1 > 0) {
        position.tokensOwed1 -= amount1;
        IERC20(token1).transfer(recipient, amount1);
    }

    emit Collect(
        msg.sender,
        recipient,
        lowerTick,
        upperTick,
        amount0,
        amount1
    );
}
```
